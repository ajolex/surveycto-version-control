<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #f8f9fa;
      color: #202124;
    }

    h2 {
      font-size: 18px;
      font-weight: 500;
      margin: 0 0 16px 0;
      color: #202124;
    }

    h3 {
      font-size: 14px;
      font-weight: 500;
      margin: 16px 0 8px 0;
      color: #5f6368;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 10px 16px;
      margin-bottom: 8px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
    }

    .btn-primary {
      background-color: #1a73e8;
      color: white;
    }

    .btn-primary:hover {
      background-color: #1557b0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
      background-color: white;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }

    .btn-secondary:hover {
      background-color: #f8f9fa;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status {
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 13px;
    }

    .status-success {
      background-color: #e6f4ea;
      color: #137333;
    }

    .status-error {
      background-color: #fce8e6;
      color: #c5221f;
    }

    .status-info {
      background-color: #e8f0fe;
      color: #1a73e8;
    }

    .history-container {
      margin-top: 16px;
    }

    .history-item {
      background: white;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .version-badge {
      background-color: #1a73e8;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .status-success-badge {
      background-color: #e6f4ea;
      color: #137333;
    }

    .status-pending-badge {
      background-color: #fef7e0;
      color: #ea8600;
    }

    .status-failed-badge {
      background-color: #fce8e6;
      color: #c5221f;
    }

    .history-form-name {
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .history-message {
      font-size: 13px;
      color: #5f6368;
      margin-bottom: 4px;
    }

    .history-meta {
      font-size: 11px;
      color: #80868b;
    }

    .empty-state {
      text-align: center;
      padding: 24px;
      color: #5f6368;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .loader {
      text-align: center;
      padding: 24px;
      color: #5f6368;
    }

    .divider {
      height: 1px;
      background-color: #dadce0;
      margin: 16px 0;
    }
  </style>
</head>

<body>
  <h2>üîß SurveyCTO Version Control</h2>

  <div id="statusMessage" class="status status-info" style="display: none;"></div>

  <button id="deployBtn" class="btn btn-primary" onclick="openDeployDialog()">
    üöÄ Deploy Form
  </button>

  <button class="btn btn-secondary" onclick="openSettings()">
    ‚öôÔ∏è Settings
  </button>

  <button class="btn btn-secondary" onclick="exportCsv()">
    üì• Export to CSV
  </button>

  <div class="divider"></div>

  <h3>Recent Deployments</h3>

  <div id="historyContainer" class="history-container">
    <div class="loader">Loading...</div>
  </div>

  <button class="btn btn-secondary" onclick="refreshHistory()" style="margin-top: 8px;">
    üîÑ Refresh
  </button>

  <script>
    // Initialize on load
    document.addEventListener('DOMContentLoaded', function () {
      checkCredentials();
      loadHistory();
    });

    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = 'status status-' + type;
      statusEl.style.display = 'block';

      if (type === 'success') {
        setTimeout(function () {
          statusEl.style.display = 'none';
        }, 3000);
      }
    }

    function hideStatus() {
      document.getElementById('statusMessage').style.display = 'none';
    }

    function checkCredentials() {
      google.script.run
        .withSuccessHandler(function (hasCredentials) {
          const deployBtn = document.getElementById('deployBtn');
          if (!hasCredentials) {
            showStatus('Please configure your credentials in Settings.', 'info');
          }
        })
        .withFailureHandler(function (error) {
          console.error('Error checking credentials:', error);
        })
        .hasCredentials();
    }

    function openDeployDialog() {
      google.script.run
        .withSuccessHandler(function () {
          // Dialog opened successfully
        })
        .withFailureHandler(function (error) {
          showStatus('Error opening dialog: ' + error.message, 'error');
        })
        .showDeployDialog();
    }

    function openSettings() {
      google.script.run
        .withSuccessHandler(function () {
          // Settings opened successfully
        })
        .withFailureHandler(function (error) {
          showStatus('Error opening settings: ' + error.message, 'error');
        })
        .showSettingsDialog();
    }

    function exportCsv() {
      google.script.run
        .withSuccessHandler(function () {
          showStatus('Export complete! Check your Google Drive.', 'success');
        })
        .withFailureHandler(function (error) {
          showStatus('Export failed: ' + error.message, 'error');
        })
        .exportVersionHistoryToCsv();
    }

    function loadHistory() {
      const container = document.getElementById('historyContainer');
      container.innerHTML = '<div class="loader">Loading...</div>';

      google.script.run
        .withSuccessHandler(function (history) {
          renderHistory(history);
        })
        .withFailureHandler(function (error) {
          container.innerHTML = '<div class="status status-error">Error loading history: ' + error.message + '</div>';
        })
        .getVersionHistory(5);
    }

    function refreshHistory() {
      loadHistory();
      showStatus('History refreshed!', 'success');
    }

    function renderHistory(history) {
      const container = document.getElementById('historyContainer');

      if (!history || history.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div>No deployments yet.</div><div>Click "Deploy Form" to get started!</div></div>';
        return;
      }

      let html = '';
      history.forEach(function (item) {
        const statusClass = getStatusClass(item.status);
        const timestamp = formatTimestamp(item.timestamp);

        html += '<div class="history-item">';
        html += '<div class="history-item-header">';
        html += '<span class="version-badge">' + escapeHtml(item.version) + '</span>';
        html += '<span class="status-badge ' + statusClass + '">' + escapeHtml(item.status) + '</span>';
        html += '</div>';
        html += '<div class="history-form-name">' + escapeHtml(item.formName) + '</div>';
        html += '<div class="history-message">' + escapeHtml(item.message) + '</div>';
        html += '<div class="history-meta">' + escapeHtml(timestamp) + ' ‚Ä¢ ' + escapeHtml(item.deployedBy) + '</div>';
        html += '</div>';
      });

      container.innerHTML = html;
    }

    function getStatusClass(status) {
      if (!status) return 'status-pending-badge';
      const statusLower = status.toLowerCase();
      if (statusLower.includes('success') || statusLower.includes('logged')) {
        return 'status-success-badge';
      } else if (statusLower.includes('fail')) {
        return 'status-failed-badge';
      }
      return 'status-pending-badge';
    }

    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      try {
        const date = new Date(timestamp);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
      } catch (e) {
        return timestamp;
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>

</html>